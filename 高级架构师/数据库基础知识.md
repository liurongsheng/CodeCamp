# 数据库基础知识

## 基本概念

三级模式-两级映像、数据库设计

### 三级模式

- 内模式：管理如何存储物理的数据，对应具体物理存储文件。【物理】
- 模式：又称为概念模式，就是我们通常使用的基本表，根据应用、需求将物理数据划分成一张张表。【表】
- 外模式：对应数据库中的视图这个级别，将表进行一定的处理后再提供给用户使用。【视图】

### 两级映像

- 外模式-模式映像：是表和视图之间的映射，存在于概念级和外部级之间，若表中数据发生了修改，只需要修改此映射，而无需修改应用程序。【逻辑独立性】
- 模式-内模式映像：是表和数据的物理存储之间的映射，存在于概念级和内部级之间，若修改了数据存储方式，只需要修改此映射，而不需要去修改应用程序。【物理独立性】

## 数据库模型

- **E-R 模型**
- **关系模型**
- 关系代数（结合 SQL 语言）

## 规范化

- **函数依赖**
- **键与约束**
- **范式**
- 模式分解

## 事务并发

- **并发三种问题**
- 三级封锁协议

## 数据库新技术

- 数据库安全与备份
- 反规范化
- 分布式数据库
- **缓存数据库**
- **数据库集群**
- **NoSql**

## 案例考点

- **ER 图 + 关系模式设计**
- **反规范化技术**
- **缓存数据库等新技术**

## 数据库设计

需要了解数据库设计生命周期的定义和各生命周期阶段产出物

- **需求分析**：即分析数据存储的要求，产出物有数据流图、数据字典、需求说明书。获得用户对系统的三个要求：信息要求、处理要求、系统要求
- **概念结构设计**：就是设计 E-R 图，也即实体-联系图。工作步骤包括：选择局部应用、逐一设计分 E-R 图、E-R 图合并
  分 E-R 图进行合并时，它们之间存在的冲突主要有以下 3 类
  - 属性冲突。同一属性可能会存在于不同的分 E-R 图中
  - 命名冲突。相同意义的属性，在不同的分 E-R 图上有着不同的命名，或是名称相同的属性在不同的分 E-R 图中代表着不同的意义
  - 结构冲突。同一实体在不同的分 E-R 图中有不同的属性，同一对象在某一分 E-R 图中被抽象为实体而在另一分 E-R 图中又被抽象为属性
- **逻辑结构设计**：将 E-R 图，转换成关系模式。工作步骤包括：确定数据模型、将 E-R 图转换成为指定的数据模型、确定完整性约束和确定用户视图
- **物理设计**：步骤包括确定数据分布、存储结构和访问方式
- **数据库实施阶段**：根据逻辑设计和物理设计阶段的结果建立数据库，编制与调试应用程序，组织数据入库，并进行试运行
- **数据库运行和维护阶段**：数据库应用系统经过试运行即可投入运行，但该阶段需要不断地对系统进行评价、调整与修改

## 函数依赖

给定一个 XX，能唯一确定一个 YY，就称 X 确定 YY，或者说 Y 依赖于 XX，例如 Y=X\*X 函数

函数依赖又可扩展以下两种规则：

- 部分函数依赖：A 可确定 C，(A,B) 也可确定 CC，(A,B)中的一部分(即 A)可以确定 C，称为部分函数依赖
- 传递函数依赖：当 A 和 B 不等价时，A 可确定 B，B 可确定 C，则 A 可确定 C，是传递函数依赖；若 A 和 B 等价，则不存在传递，直接就可确定 C

- 候选键：超键中去掉冗余的属性，剩余的属性就是候选键 【候选有唯一性，可以是多个】
- 主键：任选一个候选键，即可作为主键
- 外键：其他表中的主键
- 主属性：候选键内的属性为主属性，其他属性为非主属性

### 函数公理系统

- 自反律：若 Y∈X∈U，则 X→Y
- 增广律：若 X→Y，且 Z∈U，则 XZ→YZ
- 传递律：若 X→Y 和 Y→Z，则 X→Z
- 伪传递率：若 X→Y，WY→Z，则 XW→Z
- 合并规则：若 X→Y，X→Z，则 X→YZ
- 分解规则：若 X→Y，Z∈Y，则 X→Z

## 范式

范式的递增就是拆表的过程

- 第一范式 1NF：表中的每一个属性都不可分
- 第二范式 2NF：在第一范式基础上消除了部分函数依赖
- 第三范式 3NF：在第二范式基础上消除了传递函数依赖

第一范式的问题很明显就是存在很多冗余的数据

## 关系代数

表和表之间的运算

## 题库

- 采用三级模式结构的数据库系统中，如果对一个表创建聚簇索引，那么改变的是数据库的**内模式** 【关键词是索引】

- 假设系统中有正在运行的事务，若要转储全部数据库，则应采用(D)方式 【正在运行对应动态，全部对应全局】

  (A)静态全局转储 (B)动态增量转储 (C)静态增量转储 (D)动态全局转储

  - 静态和动态
  - 全局、增量、差量，差量是针对上一次全局之后的改变，增量是针对上一次改变之后的

数据库系统运行的基本工作单位是事务，事务相当于操作系统中的进程，是用户定义的一个数据库操作序列，这些操作序列要么全做要么全不做，是一个不可分割的工作单位

- 数据库的**原子性**是指操作序列要么全做要么全不做

- 设计时用**影子拷贝（浅拷贝）**实现

浅拷贝就是你的影子，深拷贝是你的克隆人，你没了影子也就没了，但是克隆人还活着

- 数据库从一个一致性状态变到另一个一致性状态的性质称为**一致性**

- 设计时用**设计时用完整性约束**检查实现

- 数据仓库包括数据源、数据的存储与管理、OLAP 服务器与各种报表工具、查询工具、数据分析工具、数据挖掘工具及各种基于数据仓库或数据集市的应用开发工具

- OLTP 是传统的关系型数据库联机事务处理过程

- 在数据库系统中，数据的完整性是指数据的**有效性、正确性和一致性**

在数据库设计时如果没有一定的措施确保数据库中数据的完整件，就无法从数据库中获得可信的数据。数据的完整性设计，应该贯穿在数据库设计的全过程中
例如，在数据需求分析价段，收集数据信息时，应该向有关用户调查该数的有效值范围

## 案例分析

关于数据库缓存的叙述

某大型电商平台建立了一个在线 B2B 商店系统，并在全国多地建设了货物仓储中心，通过提前备货的方式来提高货物的运送效率。但是在运营过程中，发现会出现很多跨仓储中心调货从而延误货物运送的情况。为此，该企业计划新建立一个全国仓储货物管理系统，在实现仓储中心常规管理功能之外，通过对在线 B2B 商店系统中订单信息进行及时的分析和挖掘，并通过大数据分析预测各地仓储中心中各类货物的配置数量，从而提高运送效率，降低成本。
当用户通过在线 B2B 商店系统选购货物时，全国仓储货物管理系统会通过该用户所在地址、商品类别以及仓储中心的货物信息和地址，实时为用户订单反馈货物起运地（某仓储中心）并预测送达时间。反馈送达时间的响应时间应小于 1 秒。
为满足反馈送达时间功能的性能要求，设计团队建议在全国仓储货物管理系统中采用数据缓存集群的方式，将仓储中心基本信息、商品类别以及库存数量放置在内存的缓存中，而仓储中心的其它商品信息则存储在数据库系统。

【问题 1】设计团队在讨论缓存和数据库的数据一致性问题时，李工建议采取数据实时同步更新方案，而张工则建议采用数据异步准实时更新方案。
请用 200 字以内的文字，简要介绍两种方案的基本思路，说明全国仓储货物管理系统应该采用哪种方案，并说明采取该方案的原因

实时方案：当数据库数据更新时，同时更新内存的缓存数据。
异步准实时更新方案：当数据库数据更新时，不立即更新缓存数据，而是将需要更新的操作记录成日志，再逐步排队完成更新。
本题中，建议采用准实时方案，理由是：题目中对性能有严格要求，要求 1s 内完成。实时同步方案最大的问题在于同步并发时的性能不可控。所以准实时方案才能确保该要求能实现。

【问题 2】随着业务的发展，仓储中心以及商品的数量日益增加，需要对集群部署多个缓存节点，提高缓存的处理能力。李工建议采用缓存分片方法，把缓存的数据拆分到多个节点分别存储，减轻单个缓存节点的访问压力，达到分流效果。
缓存分片方法常用的有哈希算法和一致性哈希算法，李工建议采用一致性哈希算法来进行分片。请用 200 字以内的文字简要说明两种算法的基本原理，并说明李工采用一致性哈希算法的原因。

哈希分片：通过对 key 进行 hash 操作，可以把数据分配到不同实例，这类似于取余操作，余数相同的，放在一个实例上。
一致性哈希分片：哈希分片的改进，把存储结点和需要存储的数据都存放在一个 hash 环上，数据根据 hash 值在 hash 环上按正时针方向找到对应的数据存储结点上。
一致性哈希分片的方式在扩充缓存结点时，只需要对少量数据进行存储位置的更新，而哈希分片需要对几乎所有数据进行存储位置更新。

【问题 3】全国仓储货物管理系统开发完成，在运营一段时间后，系统维护人员发现大量黑客故意发起非法的商品送达时间查询请求，造成了缓存击穿。张工建议尽快采用布隆过滤器方法解决。请用 200 字以内的文字解释布隆过滤器的工作原理和优缺点。

布隆过滤器通过一个很长的二进制向量和一系列随机映射函数来记录与识别某个数据是否在一个集合中。如果数据不在集合中，能被识别出来，不需要到数据库中进行查找，所以能将数据库查询返回值为空的查询过滤掉。

优点：
1、占用内存小
2、查询效率高
3、不需要存储元素本身，在某些对保密要求比较严格的场合有很大优势
缺点：
1、有一定的误判率，即存在假阳性，不能准确判断元素是否在集合中。
2、不能获取元素本身
3、一般情况下不能从布隆过滤器中删除元素
