# 汇编

## 32 位 CPU 寄存器

- EAX
- EBX
- ECX
- EDX

- EBP
- ESP
- ESI
- EDI

- EIP

## 64 位 CPU 寄存器

把所有的 E 替换成 R

- RAX
- RBX
- RCX
- RDX

- RBP
- RSP
- RSI
- RDI

- RIP

除了 ESP 是保存当前 Stack(栈) 的地址，前面 7 个都是通用的
0000 0000
AL 00  
AH 00
AX 0000
EAX 0000 0000

所说的 32 位、 64 位 CUP 这样的名称，实际上指的就是寄存器的大小。32 位的 CPU 寄存器是 4 个字节。

系统运行内存基址
0041000

## 基本步骤

1. 查壳脱壳
2. OD 运行
3. 使用智能查询查找关键字
4. 找到关键跳，往前找关键 CALL
5. 修改关键 CALL 完成爆破
6. 保存

## OD 快捷键

- F2 下断点

- F7 步进代码
- F8 单步运行
- F9 运行

灰色线跳转不成立
红色线跳转成立
有箭头显示说明是有跳转过来的标志

## 汇编指令

- nop 空指令，不操作
- jmp 无条件跳转
- je 条件跳转

## 必备工具

PEiD v0.95 查壳

## 常见壳与脱壳方法

压缩壳

- UPX
- ASPCAK
- TELOCK
- PELITE
- NSPACK

加密壳

- ARMADILLO
- ASPROTECT
- ACPROTECT
- EPE
- SVKP

PUSHAD (压栈)代表程序的入口点
POPAD (出栈)代表程序的出口点
OEP 程序的入口点，软件加壳就是隐藏了 OEP，只要找到真正的 OEP 就可以脱壳

1. 单步跟踪法

- 使用 F8 向下运行程序，向上使用跳转或者进入循环，在能跳过本段代码的下一行的选中执行 F4(运行到所选处)
- 一般有很大的跳转(大跨段)，比如 jmp XXXXXXXX 或者 je XXXXXXXX 或者有 RETN 的一般很快就会到程序的 OEP

F8 会运行，F8 会运行的 CALL 就 F7 跟进

PECOMPACT 特点：第一个 CALL PECOMPACT.**\*\*\*\*** 要 F7 跟入，未实现的向下跳转要实现

ASPACK 特点：遇到 CALL 就 F7 跟入，遇到向下的跳转就实现(或直接搜索 POPAD，找到后面跟 J** DELPHI.\*** 的出壳点)

UPX 特点：一路 F8 找到 POPAD

EXE32PACK 特点：

2. ESP 定律
   ESP 在 OD 的寄存器中，只要命令行下 ESP 的硬件访问断点，就会一下来到程序的 OEP

- 开始就点 F8，注意观察 OD 右上角的寄存器中 ESP 有没有突现变成红色(确切的说是关键句之后的第一个 ESP 值)
- 在命令行下：dd XXXXXXXX (这里是观察到的那个 ESP 地址，或者是 hr XXXXXXXX)，回车
- 选中下断的地址，使用断点--》硬件访--》WORD 断点
- 按一下 F9 运行程序，直接来到了跳转出，按下 F8，到达程序 OEP

3. 内存镜像法

- 点击选项--调试选项--异常，把里面的忽略全部打钩，使用 CTRL+F2 重新运行程序
- 按 ALT+M，打开内存镜像，找到程序的第一个.rsrc. 按 F2 下断点，然后按 SHIFT+F9 运行到断点，
- 接着再按 ALT+M，打开内存镜像，找到程序的第一个.rsrc.上面的.CODE(也就是 00401000 出)，按下 F2 下断点
- 然后按 SHIFT+F9 (或者是在没有异常的情况下按 F9)，直接到达程序的 OEP

4. SFX 方法

- 点击选项--调试选项--异常，把里面的忽略全部打钩，切换到 SFX 选项卡，选择"字节模式跟踪实际入口(速度非常慢)"
- 重载程序，如果程序跳出是否压缩代码，选择否，会直接到达 OEP

## 单步跟踪法笔记

通常情况下只能往下跳不要往回跳，因为壳在解压的时候会有很多的循环，在里面一直转的话会混乱

F8 能过的 CALL 就过，F8 会运行的 CALL 就 F7 跟进

PECOMPACT 特点：第一个 CALL PECOMPACT.**\*\*\*\*** 要 F7 跟入，未实现的向下跳转要实现 (按 F4 运行到所选处实现)

ASPACK 特点：遇到 CALL 就 F7 跟入，遇到向下的跳转就实现（或直接搜索 POPAD，找到后面跟  J** DELPHI.\*\*** 的出壳点）

UPX 特点：一路 F8（刚实战一个 UPX 壳：SnInput，是 UPX1.2 的壳，发现在 LOOP 解压结束之后有个未实现的 je short SnInput.0041001E，要回车跟过去 F4 才行），找到 POPAD

EXE32PACK 特点：先用"BP IsDebuggerPresent"在调用"IsDebuggerPresent"函数的地方下断（EXE32PACK 会检测是否有调试程序），然后用 ALT+F9 运行到用户区，
用 F8 运行到出现 SS=00400000（基址）同时 EDI=??????（入口实际地址的绝对地址），用 SS+EDI 就得到了程序的入口点，然后用 CTRL+G 前往入口点（CTRL+A 可以重新分析代码），!!不要 F4!!，直接 DUMP。

EZIP1 特点：EZIP1 是在壳内循环解压缩完成后再跳到程序入口点，J\*\*特别多，所以先一路 F8（包括 CALL），
当到达第一个往回大段的 JMP 时要小心了，跳过去，跟着一串代码，在后面有个未实现的 JNZ（在里面解压，解压未完成时不跳出去），来到 JNZ 这行，回车，
F4，就来到程序的入口点了。记下入口点的地址，用 LOADPE 脱壳（因为 EZIP1 会修改 PE 头，所以用 OD 脱壳再修复也没用），再修复。
（脱出来的程序比较大，可以用 LOADPE 的重建 PE 功能重建后再修复，不过重建前必须是已经修复过的程序）

JDPACK 特点：JDPACK 会分几次解压缩，所以会出现多次 POPAD 或 POPFD，所以前面先一路 F8，出现往回的 JMP 就往后面 F4（特别是有两个靠得很近的往回的 JMP 就要小心了，出口不远了），
等到出现 POPAD 后面不远就跟着 RETN 的就到了出口点了，F8 来到程序入口点，DUMP。

FSG1.33 特点：FSG1.33 是个加密壳，没有 PUSHAD 等语句，ESP 定律不适用，单步跟踪很费时间，API 断点也慢，
但是它没有 SEH 所以最好用 TC 命令进行模拟跟踪，查看内存镜像，它分为好几段，其中有 CODE 段、有 SFX, imports, resources 段，OEP（入口点）就在 CODE 段里，
模拟跟踪的地址下在 CODE 段的位置上（即 CODE 段后面一段之前，如 CODE 段开始在 401000，后面跟的段开始在 404000，则下在 404000 前），
格式为：TC EIP<**\*\*\*\***（到了入口点以后要想看得习惯点就点清除分析）

PKLITE32 1.1 特点：开始后就有一个 CALL 后面跟了一个往回跨大段的 JMP，直接来到这个 JMP 回车就来到 OEP（入口点）了，然后 F4，DUMP。（:em16:这个是最简单的了！）

VGCrypt PE Encryptor V0.75 特点：这个壳的 OEP 很好找，一路 F8，有向下的跳转就回车让跳转实现，很快就来到 OEP 了，DUMP。
但是这个壳 DUMP 有个特点，DUMP 出来的程序无法运行，并且修复后仍然不能运行，这时不用急，用 LOADPE 将修复过的程序重建一下(ReBuild PE)就行了。

Petite2.2 特点：这个壳的特点是 CALL 基本上都要跟入，所以直接追 OEP 会很麻烦。所以脱这个壳就要用到 ESP 定律，首先按照 ESP 定律下硬件断点，F9 运行后会提示硬件错误，这时按 SHIFT+F8 忽略，
紧接着后面的 CALL 全部都 F7 跟进，接下来会有一个未实现的向下大跳，用回车跳过去，F4，接下来就会看到下面有一堆的 JMP，F8 运行下去，一个 JMP 就跳回到程序的空间了，这里就是 OEP，DUMP

TELock098 特点：这个壳的特点就是 SEH（花指令）特别的多，所以脱这个壳之前一定要做好几项准备工作：
1、把调试选项中，除了“忽略 KERNEL32 中的内存访问异常”外的忽略异常都去掉；
2、一边数一边按 SHIFT+F9（跳过 SEH），一直到按下去以后程序运行了；
3、重新运行，刚才不是数了按多少下就运行了吗？现在少按一下，这样就会中断在最后一个 SEH 的前面了，OD 右下方会显示下一个 SE 的句柄，按 CTRL+G 到那个地址，F2，SHIFT+F9，
接下来就按照常规跟，一直跟到在一个 POPAD 后面不远跟着个“jmp dword ptr ss:[esp-30]”这里就是跳向 OEP 的了！回车，F4,DUMP。修复时会出现获取输入信息会出现无效的，
先点“显示无效的”，然后右键“追踪层次 3”，追踪好以后再显示无效的，剪切掉就好了，修复。

yoda's Crypter 特点：这个壳总体来说特点还是比较鲜明的，所以也比较好脱。首先运行后会来到一堆的“00 00 00 00”的代码这里异常，这时我们就得到了下个 SE 的地址，
CTRL+G，下断，SHIFT+F9，这里就是这个壳最有特点的地方了！前面一堆什么不管，最后三句是：
5F pop edi  //在这里的时候，EDI 的值就是 OEP 了
C9 leave
C3 retn
讲到这个壳就顺便提一下仙剑壳，其实仙剑壳就是在前面加了一堆花指令的 yoda's Crypter 壳
前面一路 SHIFT+F9 也会来到一个很熟悉的地方：一堆“00000000”，不过仙剑壳会多点其他的数字，
但是没什么大差别，对付的方法都是一模一样的，这里就不多说了。
