# 磁盘问题修复

对于大部分用户而言，出现数据丢失的情况以后，他们并不知道如何处理，往往心急如焚，不知所措

利用 `DBR` 分区数据来尝试恢复分区，NTFS系统的 `DBR` 标志为`EB 52 90`，使用 WinHex 搜索-查找 16 进制数值 `EB5290`

- FAT32，标志 `EB 58 90`
- NTFS，标志 `EB 52 90`

```text
dbr 的 28 至 2f 保存的是文件系统扇区总数，通过数据解释器查看该分区扇区总数为 409,599，这里使用当前扇区 128 加上 409,599 再加上 1 得到下一个分区的位于第 409,728 扇区

跳转至第409,728扇区，该扇区头部发现DBR标志EB 52 90，验证了我们计算的扇区大小的正确性。
```

<https://zhuanlan.zhihu.com/p/485713280>

<https://blog.csdn.net/anquanfun/article/details/128540738>

## 原理

- 盘片(Platter)
- 磁头(Head) 从 0 开始顺序编号
- 磁道(Track) 磁盘在格式化时被划分成许多同心圆，这些同心圆轨迹叫磁道，磁道从外向内从 0 开始顺序编号
- 柱面(Cylinder) 所有盘面上同一磁道构成一个圆柱，这个就是柱面，每个圆柱上的磁头由上到下从 0 开始编号
- 扇区(Sector) 样式类似同心圆的磁道被划分为一段段的圆弧，每段圆弧叫做一个扇区，扇区从 1 开始编号，每个扇区中的数据作为一个单元同时读出或写入

同样的转速，外圈的磁道是比较快的

柱面的磁道切换只需要电子切换磁头，选取柱面需要通过机械切换

所以通常是一个磁道写满数据后，就在同一柱面的下一个盘面来写，一个柱面写满后才移到下一个柱面，从下一个柱面的 1 扇区开始写数据

硬盘容量 = `盘面数 * 柱面数 * 扇区数 * 512 字节`

字节 Byte: 1TB = 2^10 GB = 2^20 MB = 2^30 KB = 2^40 B = 1099511627776 Byte

十六进制: 0 ~ 9, A(10), B(11), C(12), D(13), E(14), F(15)

一个扇区主要由两个部分组成

- 存储数据地点的标识符，扇区头包含扇区的三维地址(圆柱、磁头、扇区)和物理扇区包含一个不良扇区的标志，扇区头以一个 CRC 数值结尾，用来确定扇区头已经正确读出
- 存储数据的数据段，可分为数据和保护数据的结错码 ECC

硬盘低级格式化 (low level format) 简称低格，也称 硬盘物理格式化(physical format)

- 检测硬盘磁介质
- 划分磁道
- 为硬盘的每个磁道按指定的交叉因子间隔划分扇区
- 将扇区 ID 放置道每个磁道上，完成对扇区的设置
- 对硬盘表面进行测试，对已损坏的磁道和扇区做标记
- 给硬盘中的每个扇区写入某一 ASCII 码字符

硬盘低级格式化对硬盘有较大的磨损，影响其使用寿命，一般不轻易考虑格式化

### 硬盘数据结构

MBR 区，即主引导记录区，位于整个硬盘的 0 磁道 0 柱面 1 扇区。在总共 512 字节的主引导扇区中，MBR的引导程序占用其中的前 446 个字节 (偏移 0 ~ 1BDH)，随后的 64 个字节(偏移 1BEH ~ 1FDH) 为 DPT(Disk Partition Table，硬盘分区表)，最后两个字节 "55 AA" (偏移 1FEH ~ 1FFH)是分区有效结束标志。共同组成硬盘主引导记录，也成主引导扇区

DBR 区，DBR(DOS Boot Record)即操作系统引导记录区，通常位于硬盘 0 柱 1 面 1 扇区，是操作系统可以直接访问的第一个扇区

通过主引导记录定义的硬盘分区表，最多只能描述4个分区，微软为了解决这个问题，采用了虚拟MBR技术，在主MBR定义分区的时候，将多余的容量定义为拓展分区，指定该拓展分区的起止位置，根据起始位置指向的硬盘的某一个扇区，作为下一个分区表项，接着在该扇区继续定义分区。如果只有一个分区就定义该分区然后结束，如果不止一个分区，就定义一个基本分区和一个拓展分区，拓展分区再指向下一个分区描述扇区，在该扇区上按照上述原则继续定义分区，直到分区定义结束

NTFS (New Technology File System)文件系统：
在1993年随 Windows NT的第一个版本推出而面世，是一个性能优良的文件系统。基于可恢复文件结构而设计，可使用户数据文件不会有丢失或毁坏的危险

使用 卷 这个术语来表示一个逻辑磁盘，不必是一个相邻的磁盘，利用 B-Tree 文件管理方法来跟踪文件在磁盘上的位置，这种技术比先前的链表技术有更多的优越性。文件名顺序存放，因而查找速度更快。也使用 簇 作为最小的分配单位，簇的大小也称簇因子，由 NTFS 格式化程序确定，NFTS支持的簇大小为 512、1024、2048、4096个字节

硬盘启动时首先由 BIOS 读入 MBR 的内容，以确定各个逻辑驱动器及初始参数，然后调入活动分区的DBR，将控制权交给 DBR

## NTFS文件系统结构

原则：磁盘上任何事物都为文件

文件按簇进行分配，一个簇必须是物理扇区的整数倍，而且总是2的整数次方

在 NTFS 中，所有存储在卷上的数据都包含在文件中，包括用来定位和获取文件的数据结构，引导程序以及记录卷自身大小和使用情况的位图文件，在文件中存储一切使得文件系统很容易定位和维护数据

文件通过主文件表(MFT, Master File Table)来确定在其磁盘上的存储位置，主文件表示一个与文件相对应得数据库，卷中的每一个文件都有一个文件记录。主文件表自身也有它自己的文件记录

MFT中文件记录大小一般是固定的，不管簇的大小是多少，均为1KB，这个概念相当于Linux中的inode(i节点)。文件记录在MFT文件记录数组中物理上是连续的，且从0开始编号，MFT仅供系统本身组织、架构文件系统使用，这在NTFS中被称为元数据，是存储在卷上支持文件系统格式管理的数据，不能被应用程序访问，只能为系统提供服务

MFT的前16个元数据文件非常重要，为防止数据丢失，NFTS系统在卷存储中部对它们进行了备份

NTFS 分区的区域关系：

- Partition boot sector 分区引导扇区
- Master file table 主文件表
- System files 系统文件
- File area 文件区域

NTFS 使用逻辑簇号(LCN, Logical Cluster Number)和虚拟簇号(VCN, Virtual Cluster Number)来对簇进行定位，LCN是对整个卷中所有的簇从头到尾所进行的简单编号。用卷因子乘以LCN，NTFS就能够得到卷上的物理字节偏移量，从而得到物理磁盘的地址。VCN则是对属于特定文件的簇从头到尾进行编号，以便于引用文件中的数据
